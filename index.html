<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2563eb">
<link rel="manifest" href="manifest.json">
<title>Dynamic Incident Form</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/BlizzardWolf7/Toast-Notification-Library@main/toast.css">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/gh/BlizzardWolf7/Toast-Notification-Library@main/toast.js"></script>
<script src="incidents.js"></script>
<script src="guidebook-data.js"></script>
</head>
<body>

<h2>Advanced Dynamic Incident Report Form</h2>
<div class="tab-container">
  <button type="button" class="tab-button active" data-tab="add">Add Incident</button>
  <button type="button" class="tab-button" data-tab="dashboard">Dashboard</button>
  <button type="button" class="tab-button" data-tab="view">View Incidents</button>
  <button type="button" class="tab-button" data-tab="guide">Quick Reference</button>
</div>

<div id="addIncidentPane" class="tab-pane active">
<form id="incidentForm">
  <div id="editBanner" class="edit-banner hidden" role="status">
    <span class="edit-banner__label">Editing stored incident</span>
    <strong id="editRecordLabel"></strong>
    <button type="button" id="cancelEditButton">Cancel edit</button>
  </div>
    <div class="label-with-tip">
      <label for="operationalContext">Operational context:</label>
      <button type="button" class="info-tip" data-tooltip="Indicate whether you are operating in a peacetime/garrison or wartime/deployed environment to tailor follow-up workflows." aria-label="Operational context information">i</button>
    </div>
    <select id="operationalContext">
      <option value="peace">Peacetime / garrison operations</option>
      <option value="war">Wartime / deployed operations</option>
    </select>
  <div class="label-with-tip">
    <label for="incidentCategory">Incident category:</label>
    <button type="button" class="info-tip" data-tooltip="Pick the general category that best fits the situation." aria-label="Incident category information">i</button>
  </div>
  <select id="incidentCategory">
    <option value="">--Select category--</option>
  </select>

  <div class="label-with-tip">
    <label for="incidentType">Incident type:</label>
    <button type="button" class="info-tip" data-tooltip="Select the specific incident in the chosen category to load relevant fields." aria-label="Incident type information">i</button>
  </div>
  <select id="incidentType" disabled>
    <option value="">--Select incident--</option>
  </select>

  <div id="workplaceSection" class="hidden workplace-toggle">
    <div class="label-with-tip">
      <label for="workplaceIncident">Workplace incident?</label>
      <button type="button" class="info-tip" data-tooltip="Flag if the injury happened to staff while working. Additional reporting may be required." aria-label="Workplace incident information">i</button>
    </div>
    <input type="checkbox" id="workplaceIncident">
  </div>

  <div id="workplaceWarning" class="warning-banner hidden" role="alert">
    This workplace injury must be reported to the Safety Coordinator to comply with workplace safety laws.
  </div>

  <div id="basicFields" class="hidden">
      <div class="label-with-tip">
        <label for="patientName">Patient name:</label>
        <button type="button" class="info-tip" data-tooltip="Record the casualty's full name or identifier for follow-up documentation." aria-label="Patient name information">i</button>
      </div>
      <input type="text" id="patientName" placeholder="Full name or identifier">

      <div class="label-with-tip">
        <label for="rosterNumber">Roster / MA number:</label>
        <button type="button" class="info-tip" data-tooltip="Capture the roster, MA number, or unit ID used for accountability." aria-label="Roster number information">i</button>
      </div>
      <input type="text" id="rosterNumber" placeholder="Roster number, MA number, or ID code">

    <div class="label-with-tip">
      <label for="incidentDateTime">Incident time:</label>
      <button type="button" class="info-tip" data-tooltip="Log when the incident occurred. Use the quick actions for now or recent times." aria-label="Incident time information">i</button>
    </div>
    <div id="incidentTimeQuickActions" class="field-hints">
      <button type="button" data-action="now" data-severity="info">Now</button>
      <button type="button" data-action="minus-10" data-severity="info">10 minutes ago</button>
      <button type="button" data-action="minus-30" data-severity="info">30 minutes ago</button>
      <button type="button" data-action="unknown" data-severity="neutral">Unknown</button>
    </div>
    <input type="datetime-local" id="incidentDateTime">

    <div class="label-with-tip">
    <label for="location">Location:</label>
      <button type="button" class="info-tip" data-tooltip="Document where the incident occurred for safety follow-up and reporting." aria-label="Location information">i</button>
    </div>
    <input type="text" id="location" placeholder="Where did it happen?">

    <div class="label-with-tip">
    <label for="description">Description:</label>
      <button type="button" class="info-tip" data-tooltip="Summarize what happened, patient presentation, and notable observations." aria-label="Description information">i</button>
    </div>
    <textarea id="description" rows="3" placeholder="Describe the incident..."></textarea>

    <div class="label-with-tip">
      <label for="mechanismOfInjury">Mechanism of injury (MOI):</label>
      <button type="button" class="info-tip" data-tooltip="Document how the injury occurred (blast, fall, MVC, etc.)." aria-label="Mechanism of injury information">i</button>
    </div>
    <input type="text" id="mechanismOfInjury" placeholder="e.g., Blast injury from IED">

    <div class="label-with-tip">
      <label for="currentStatus">Current status:</label>
      <button type="button" class="info-tip" data-tooltip="Track whether the incident is still being managed, under observation, or fully handed off." aria-label="Current status information">i</button>
    </div>
    <select id="currentStatus">
      <option value="active">Active / ongoing care</option>
      <option value="monitoring">Monitoring / awaiting follow-up</option>
      <option value="completed">Completed / handed off</option>
    </select>
  </div>

  <div id="vitalsFields" class="hidden">
    <div class="vital-field" data-vital="bloodPressure">
      <div class="field-title">
    <label for="bloodPressure">Blood Pressure:</label>
        <button type="button" class="info-tip" data-tooltip="Indicates circulatory status and perfusion—key for shock, bleeding, or cardiac issues." aria-label="Blood pressure information">i</button>
        <div class="field-hints" data-for="bloodPressure">
          <button type="button" data-value="120/80" data-severity="normal">Normal / 120/80</button>
          <button type="button" data-value="90/60" data-severity="caution">Low / 90/60</button>
          <button type="button" data-value="150/95" data-severity="caution">High / 150/95</button>
          <button type="button" data-value="Unable to obtain" data-severity="neutral">Unable to obtain</button>
        </div>
      </div>
      <input type="text" id="bloodPressure" placeholder="e.g., 120/80">
      <div class="vital-warning hidden" data-warning="bloodPressure"></div>
    </div>

    <div class="vital-field" data-vital="spo2">
      <div class="field-title">
    <label for="spo2">SpO₂ (%):</label>
        <button type="button" class="info-tip" data-tooltip="Shows oxygen saturation and effectiveness of breathing—critical for respiratory or cardiac events." aria-label="SpO2 information">i</button>
        <div class="field-hints" data-for="spo2">
          <button type="button" data-value="99" data-severity="normal">Normal / 99%</button>
          <button type="button" data-value="90" data-severity="critical">Low / 90%</button>
          <button type="button" data-value="Unknown" data-severity="neutral">Unknown</button>
        </div>
      </div>
      <input type="text" id="spo2" placeholder="e.g., 98">
      <div class="vital-warning hidden" data-warning="spo2"></div>
    </div>

    <div class="vital-field" data-vital="heartRate">
      <div class="field-title">
    <label for="heartRate">Heart Rate (bpm):</label>
        <button type="button" class="info-tip" data-tooltip="Reflects cardiac output and stress response—monitor for arrhythmias or perfusion problems." aria-label="Heart rate information">i</button>
        <div class="field-hints" data-for="heartRate">
          <button type="button" data-value="80" data-severity="normal">Normal / 80 bpm</button>
          <button type="button" data-value="120" data-severity="caution">Tachycardic / 120 bpm</button>
          <button type="button" data-value="50" data-severity="caution">Bradycardic / 50 bpm</button>
          <button type="button" data-value="Unknown" data-severity="neutral">Unknown</button>
        </div>
      </div>
      <input type="text" id="heartRate" placeholder="e.g., 75">
      <div class="vital-warning hidden" data-warning="heartRate"></div>
    </div>

    <div class="vital-field" data-vital="respiratoryRate">
      <div class="field-title">
        <label for="respiratoryRate">Respiratory Rate (breaths/min):</label>
        <button type="button" class="info-tip" data-tooltip="Tracks breathing effort and distress—important for asthma, overdoses, or metabolic imbalance." aria-label="Respiratory rate information">i</button>
        <div class="field-hints" data-for="respiratoryRate">
          <button type="button" data-value="16" data-severity="normal">Normal / 16</button>
          <button type="button" data-value="24" data-severity="caution">Rapid / 24</button>
          <button type="button" data-value="8" data-severity="critical">Slow / 8</button>
          <button type="button" data-value="Unknown" data-severity="neutral">Unknown</button>
        </div>
      </div>
      <input type="text" id="respiratoryRate" placeholder="e.g., 16">
      <div class="vital-warning hidden" data-warning="respiratoryRate"></div>
    </div>

    <div class="vital-field" data-vital="temperature">
      <div class="field-title">
        <label for="temperature">Temperature (°C):</label>
        <button type="button" class="info-tip" data-tooltip="Identifies infection, heat illness, or hypothermia risk to guide interventions." aria-label="Temperature information">i</button>
        <div class="field-hints" data-for="temperature">
          <button type="button" data-value="37" data-severity="normal">Normal / 37°C</button>
          <button type="button" data-value="38.5" data-severity="caution">Fever / 38.5°C</button>
          <button type="button" data-value="35" data-severity="critical">Hypothermia / 35°C</button>
          <button type="button" data-value="Not taken" data-severity="neutral">Not taken</button>
        </div>
      </div>
      <input type="text" id="temperature" placeholder="e.g., 37">
      <div class="vital-warning hidden" data-warning="temperature"></div>
    </div>

    <div class="vital-field" data-vital="bloodGlucose">
      <div class="field-title">
        <label for="bloodGlucose">Blood Glucose (mg/dL):</label>
        <button type="button" class="info-tip" data-tooltip="Impacts mental status and seizure risk—especially critical for diabetic or altered patients." aria-label="Blood glucose information">i</button>
        <div class="field-hints" data-for="bloodGlucose">
          <button type="button" data-value="95" data-severity="normal">Normal / 95</button>
          <button type="button" data-value="180" data-severity="caution">High / 180</button>
          <button type="button" data-value="60" data-severity="critical">Low / 60</button>
          <button type="button" data-value="Not taken" data-severity="neutral">Not taken</button>
        </div>
      </div>
      <input type="text" id="bloodGlucose" placeholder="e.g., 95">
      <div class="vital-warning hidden" data-warning="bloodGlucose"></div>
    </div>

    <div class="vital-field" data-vital="painScore">
      <div class="field-title">
        <label for="painScore">Pain Score (0-10):</label>
        <button type="button" class="info-tip" data-tooltip="Tracks pain severity and treatment response—use the patient's rating when possible." aria-label="Pain score information">i</button>
        <div class="field-hints" data-for="painScore">
          <button type="button" data-value="0" data-severity="normal">No pain / 0</button>
          <button type="button" data-value="4" data-severity="caution">Mild pain / 4</button>
          <button type="button" data-value="8" data-severity="critical">Severe pain / 8</button>
          <button type="button" data-value="Unable to rate" data-severity="neutral">Unable to rate</button>
        </div>
      </div>
      <input type="text" id="painScore" placeholder="e.g., 4">
    </div>

    <div class="vital-field" data-vital="pupilResponse">
      <div class="field-title">
        <label for="pupilResponse">Pupil Response:</label>
        <button type="button" class="info-tip" data-tooltip="Changes can indicate neurological compromise or drug influence." aria-label="Pupil response information">i</button>
        <div class="field-hints" data-for="pupilResponse">
          <button type="button" data-value="PERRLA" data-severity="normal">PERRLA</button>
          <button type="button" data-value="Sluggish" data-severity="caution">Sluggish</button>
          <button type="button" data-value="Non-reactive" data-severity="critical">Non-reactive</button>
          <button type="button" data-value="Unknown" data-severity="neutral">Unknown</button>
        </div>
      </div>
      <input type="text" id="pupilResponse" placeholder="e.g., PERRLA">
    </div>
    <div class="vital-field" data-vital="avpu">
      <div class="field-title">
        <label for="avpu">AVPU status:</label>
        <button type="button" class="info-tip" data-tooltip="Select the casualty's responsiveness: Alert, responds to Verbal or Pain, or Unresponsive." aria-label="AVPU information">i</button>
        <div class="field-hints" data-for="avpu">
          <button type="button" data-value="alert" data-severity="normal">Alert</button>
          <button type="button" data-value="verbal" data-severity="caution">Verbal</button>
          <button type="button" data-value="pain" data-severity="critical">Pain</button>
          <button type="button" data-value="unresponsive" data-severity="critical">Unresponsive</button>
        </div>
      </div>
      <select id="avpu">
        <option value="">--Select AVPU status--</option>
        <option value="alert">Alert</option>
        <option value="verbal">Responds to verbal</option>
        <option value="pain">Responds to pain</option>
        <option value="unresponsive">Unresponsive</option>
      </select>
    </div>
  </div>

  <div id="prolongedCareSection" class="prolonged-care hidden">
    <div class="prolonged-header">
      <strong>Prolonged tactical field care</strong>
      <span>Log recurring vital assessments during extended casualty care.</span>
    </div>
    <div class="prolonged-controls">
      <label for="checkupTime">Assessment timestamp:</label>
      <input type="datetime-local" id="checkupTime">
      <label for="checkupNotes">Notes / interventions:</label>
      <textarea id="checkupNotes" rows="2" placeholder="Hemorrhage re-check, fluids, medications, etc."></textarea>
      <button type="button" id="recordCheckupButton">Add follow-up check</button>
    </div>
    <ul id="checkupList" class="checkup-list"></ul>
    <p id="checkupPlaceholder" class="checkup-placeholder hidden">No follow-up checks logged yet.</p>
  </div>

  <div id="treatmentFields" class="hidden">
    <div class="label-with-tip">
      <label for="treatment">Treatment / Interventions:</label>
      <button type="button" class="info-tip" data-tooltip="Document interventions, medications, and patient response for continuity of care." aria-label="Treatment information">i</button>
    </div>
    <div id="treatmentQuickActions" class="field-hints hidden"></div>
    <textarea id="treatment" rows="4" placeholder="Document treatments, medications, and response..."></textarea>
  </div>

  <div id="followUpSection" class="hidden follow-up-section">
    <div class="label-with-tip">
      <label>Patient follow-up / disposition:</label>
      <button type="button" class="info-tip" data-tooltip="Record what happens next so staff can coordinate follow-up and documentation." aria-label="Patient follow-up information">i</button>
    </div>
    <div id="followUpWarning" class="follow-up-warning hidden" role="alert"></div>
    <div class="follow-up-options">
        <label class="follow-up-option" data-context="peace">
        <input type="radio" name="followUp" value="none">
        <span>No follow-up needed – treated on-site and released</span>
      </label>
        <label class="follow-up-option" data-context="peace">
        <input type="radio" name="followUp" value="doctor">
        <span>Advised to see a doctor – non-urgent follow-up</span>
      </label>
        <label class="follow-up-option" data-context="peace">
        <input type="radio" name="followUp" value="pharmacy">
        <span>Advised to visit a pharmacy – minor injuries or medication needed</span>
      </label>
        <label class="follow-up-option" data-context="peace">
        <input type="radio" name="followUp" value="ambulance">
        <span>Sent via ambulance – transported to hospital or urgent care</span>
      </label>
        <label class="follow-up-option" data-context="both">
        <input type="radio" name="followUp" value="refused">
        <span>Refused further care – patient declined additional treatment</span>
      </label>
        <label class="follow-up-option" data-context="both">
        <input type="radio" name="followUp" value="other">
        <span>Other / notes – provide specific instructions</span>
      </label>
        <label class="follow-up-option" data-context="war">
          <input type="radio" name="followUp" value="remain-with-unit">
          <span>Returned to unit – managed by organic medic / squad leader</span>
        </label>
        <label class="follow-up-option" data-context="war">
          <input type="radio" name="followUp" value="role1-aid-station">
          <span>Evacuated to Role 1 aid station / forward aid post</span>
        </label>
        <label class="follow-up-option" data-context="war">
          <input type="radio" name="followUp" value="role2-surgical">
          <span>Evacuated to Role 2 surgical team / damage control resuscitation</span>
        </label>
        <label class="follow-up-option" data-context="war">
          <input type="radio" name="followUp" value="medevac">
          <span>MEDEVAC requested – theater/strategic evacuation initiated</span>
      </label>
    </div>
    <div id="followUpOtherWrapper" class="follow-up-notes hidden">
      <textarea id="followUpOther" rows="3" placeholder="Detail specific follow-up instructions or notes..."></textarea>
    </div>
  </div>

  <button type="submit">Submit</button>
</form>
</div>

<div id="dashboardPane" class="tab-pane">
  <section class="dashboard">
    <header class="dashboard-header">
      <div>
        <h3>Incident Overview</h3>
        <p class="dashboard-subtitle">High-level metrics and trends from locally stored reports.</p>
      </div>
      <button type="button" id="refreshDashboard" class="dashboard-refresh">Refresh metrics</button>
    </header>

    <div class="dashboard-cards">
      <article class="dashboard-card">
        <h4>Total incidents</h4>
        <p id="dashboardTotalIncidents" class="dashboard-card__value">0</p>
        <span class="dashboard-card__hint">Stored in this browser</span>
      </article>
      <article class="dashboard-card">
        <h4>Logged in last 24h</h4>
        <p id="dashboardLast24Hours" class="dashboard-card__value">0</p>
        <span class="dashboard-card__hint">Based on incident time or submission</span>
      </article>
      <article class="dashboard-card">
        <h4>Life-threatening</h4>
        <p id="dashboardLifeThreatening" class="dashboard-card__value">0</p>
        <span class="dashboard-card__hint">Flagged as immediate risk</span>
      </article>
      <article class="dashboard-card">
        <h4>Serious (non-life)</h4>
        <p id="dashboardSerious" class="dashboard-card__value">0</p>
        <span class="dashboard-card__hint">Requires significant follow-up</span>
      </article>
      <article class="dashboard-card">
        <h4>Peacetime context</h4>
        <p id="dashboardPeaceCount" class="dashboard-card__value">0</p>
        <span class="dashboard-card__hint">Operational context = Peacetime</span>
      </article>
      <article class="dashboard-card">
        <h4>Wartime context</h4>
        <p id="dashboardWarCount" class="dashboard-card__value">0</p>
        <span class="dashboard-card__hint">Operational context = Wartime</span>
      </article>
      <article class="dashboard-card">
        <h4>Active incidents</h4>
        <p id="dashboardActiveIncidents" class="dashboard-card__value">0</p>
        <span class="dashboard-card__hint">Marked as active / ongoing</span>
      </article>
      <article class="dashboard-card">
        <h4>Completed / handed off</h4>
        <p id="dashboardCompletedIncidents" class="dashboard-card__value">0</p>
        <span class="dashboard-card__hint">Status set to completed or handed off</span>
      </article>
    </div>

    <div class="dashboard-panels">
      <section class="dashboard-panel">
        <h4>Incidents by category</h4>
        <ul id="dashboardCategoryList" class="dashboard-list"></ul>
      </section>
      <section class="dashboard-panel">
        <h4>Status overview</h4>
        <ul id="dashboardStatusList" class="dashboard-list"></ul>
      </section>
      <section class="dashboard-panel">
        <h4>Top incident types</h4>
        <ul id="dashboardIncidentTypeList" class="dashboard-list"></ul>
      </section>
      <section class="dashboard-panel">
        <h4>Follow-up disposition</h4>
        <ul id="dashboardFollowUpList" class="dashboard-list"></ul>
      </section>
    </div>

    <section class="dashboard-panel dashboard-panel--full">
      <h4>Most recent incidents</h4>
      <ul id="dashboardRecentList" class="dashboard-recent"></ul>
    </section>
  </section>
</div>

<div id="viewIncidentsPane" class="tab-pane">
  <section class="incident-history">
    <h3>Stored Incidents</h3>
    <p class="history-hint">Incidents are stored locally in this browser. Switch to the Add tab to log new reports.</p>
    <div class="filters-panel">
      <div class="filter-group">
        <label for="filterSearch">Search keywords</label>
        <input type="text" id="filterSearch" placeholder="Search name, roster, description, treatments...">
      </div>
      <div class="filter-row">
        <div class="filter-group">
          <label for="filterCategory">Category</label>
          <select id="filterCategory">
            <option value="">All categories</option>
          </select>
        </div>
      <div class="filter-group">
        <label for="filterStatus">Status</label>
        <select id="filterStatus">
          <option value="">All statuses</option>
          <option value="active">Active / ongoing care</option>
          <option value="monitoring">Monitoring / awaiting follow-up</option>
          <option value="completed">Completed / handed off</option>
        </select>
      </div>
        <div class="filter-group">
          <label for="filterContext">Operational context</label>
          <select id="filterContext">
            <option value="">All contexts</option>
            <option value="peace">Peacetime</option>
            <option value="war">Wartime</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterDisposition">Disposition</label>
          <select id="filterDisposition">
            <option value="">All follow-ups</option>
          </select>
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-group">
          <label for="filterSeriousness">Seriousness</label>
          <select id="filterSeriousness">
            <option value="">Any</option>
            <option value="lifeThreatening">Life-threatening</option>
            <option value="serious">Serious</option>
            <option value="potentialLifeThreatening">Potentially critical</option>
            <option value="minor">Minor</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterTimeFrom">Incident after</label>
          <input type="datetime-local" id="filterTimeFrom">
        </div>
        <div class="filter-group">
          <label for="filterTimeTo">Incident before</label>
          <input type="datetime-local" id="filterTimeTo">
        </div>
      </div>
      <div class="filters-actions">
        <button type="button" id="applyFilters">Apply filters</button>
        <button type="button" id="clearFilters">Clear filters</button>
      </div>
    </div>
    <div class="history-actions">
      <button type="button" id="printIncidents">Export log (PDF)</button>
      <button type="button" id="downloadIncidents">Download log (JSON)</button>
      <button type="button" id="clearIncidents">Clear stored incidents</button>
    </div>
    <div id="incidentList" class="incident-list"></div>
  </section>
</div>

<div id="guidePane" class="tab-pane">
  <section class="guidebook">
    <div class="guidebook-header">
      <div class="guidebook-search">
        <label for="guideSearch">Search reference</label>
        <input type="search" id="guideSearch" placeholder="Search protocols, mnemonics, equipment...">
      </div>
      <div class="guidebook-filters">
        <label for="guideCategory">Category</label>
        <select id="guideCategory">
          <option value="">All categories</option>
        </select>
      </div>
    </div>
    <div id="guideResults" class="guidebook-results"></div>
  </section>
</div>

<div id="printContainer" class="print-container"></div>

<footer class="app-footer">
  <span>Advanced Dynamic Incident Report</span>
  <span id="appVersionDisplay"></span>
</footer>

<script src="script.js"></script>

</body>
</html>
